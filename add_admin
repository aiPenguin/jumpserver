#!/bin/bash
# Usage: add-admin <username> <public_key_file_path>

if [ $# -ne 2 ]; then
    echo "Usage: add-admin <username> <public_key_file_path>"
    exit 1
fi

USERNAME=$1
PUB_KEY_FILE=$2

# Check if public key file exists
if [ ! -f "$PUB_KEY_FILE" ]; then
    echo "Error: Public key file $PUB_KEY_FILE does not exist"
    exit 1
fi

# Create user
useradd -m -G jumpbox-admin -s /bin/bash $USERNAME

# Create SSH directory
mkdir -p /home/$USERNAME/.ssh
chmod 700 /home/$USERNAME/.ssh

# Add public key
cat $PUB_KEY_FILE > /home/$USERNAME/.ssh/authorized_keys
chmod 600 /home/$USERNAME/.ssh/authorized_keys
chown -R $USERNAME:$USERNAME /home/$USERNAME/.ssh

# Set never expire
chage -E -1 $USERNAME

# Add user to sudoers
echo "$USERNAME ALL=(ALL) ALL" > /etc/sudoers.d/$USERNAME
chmod 440 /etc/sudoers.d/$USERNAME

echo "Administrator user $USERNAME has been created"